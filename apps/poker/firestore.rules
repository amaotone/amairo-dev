rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ルームのドキュメントに対するルール
    match /rooms/{roomId} {
      // 読み取り: 誰でも可能
      allow read: if true;
      
      // 作成: 誰でも可能だが、必要なフィールドのみ許可
      allow create: if 
        // 必須フィールドの存在確認
        request.resource.data.keys().hasOnly(['createdAt']) &&
        // createdAtがサーバータイムスタンプであることを確認
        request.resource.data.createdAt == request.time;
      
      allow update: if
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['expireAt', 'isOpen']);

      // メンバーのサブコレクションに対するルール
      match /members/{memberId} {
        // 読み取り: 誰でも可能
        allow read: if true;
        
        // 作成・更新: 必要なフィールドのみ許可
        allow write: if true;
      }
    }
  }
} 
