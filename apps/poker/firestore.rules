rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ルームのドキュメントに対するルール
    match /rooms/{roomId} {
      // 読み取り: 誰でも可能
      allow read: if true;
      
      // 作成: 誰でも可能だが、必要なフィールドのみ許可
      allow create: if 
        // 必須フィールドの存在確認
        request.resource.data.keys().hasOnly(['createdAt']) &&
        // createdAtがサーバータイムスタンプであることを確認
        request.resource.data.createdAt == request.time;
      
      allow update: if
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['expireAt', 'isVoting']);

      // メンバーのサブコレクションに対するルール
      match /members/{memberId} {
        // 読み取り: 誰でも可能
        allow read: if true;
        
        // 作成・更新: 必要なフィールドのみ許可
        allow write: if
          // 必須フィールドの存在確認
          request.resource.data.keys().hasOnly(['name', 'selectedCard']) &&
          // nameは文字列で1文字以上
          request.resource.data.name is string &&
          request.resource.data.name.size() > 0 &&
          // selectedCardは文字列またはnull
          (request.resource.data.selectedCard == null ||
           (request.resource.data.selectedCard is string &&
            request.resource.data.selectedCard.size() > 0));
      }
    }
  }
} 
